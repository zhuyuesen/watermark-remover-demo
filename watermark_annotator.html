<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´å°ä½ç½®æ ‡æ³¨å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #007AFF;
            background: #f0f8ff;
        }
        .upload-area.dragover {
            border-color: #007AFF;
            background: #e6f2ff;
        }
        canvas {
            border: 1px solid #ddd;
            cursor: crosshair;
            max-width: 100%;
            display: block;
            margin: 20px auto;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0051D5;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .danger {
            background: #ff3b30;
        }
        .danger:hover {
            background: #d32f2f;
        }
        #output {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        .info {
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
        .rect-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f0f0f0;
            margin: 5px 0;
            border-radius: 4px;
        }
        .rect-info button {
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ æ°´å°ä½ç½®æ ‡æ³¨å·¥å…·</h1>
        <p class="info">æ‹–æ‹½å›¾ç‰‡åˆ°ä¸‹æ–¹åŒºåŸŸï¼Œæˆ–ç‚¹å‡»é€‰æ‹©å›¾ç‰‡ã€‚ç„¶ååœ¨å›¾ç‰‡ä¸Šæ‹–åŠ¨é¼ æ ‡æ¡†é€‰æ°´å°åŒºåŸŸã€‚</p>

        <div class="upload-area" id="uploadArea">
            <p>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>

        <canvas id="canvas"></canvas>

        <div class="controls">
            <button id="undoBtn" disabled>â†¶ æ’¤é”€ä¸Šä¸€ä¸ª</button>
            <button id="clearBtn" class="danger" disabled>ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
            <button id="saveBtn" disabled>ğŸ’¾ ä¿å­˜ä½ç½®ä¿¡æ¯</button>
            <button id="copyBtn" disabled>ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
        </div>

        <div id="rectangles"></div>

        <div id="output"></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const output = document.getElementById('output');
        const undoBtn = document.getElementById('undoBtn');
        const clearBtn = document.getElementById('clearBtn');
        const saveBtn = document.getElementById('saveBtn');
        const copyBtn = document.getElementById('copyBtn');
        const rectanglesDiv = document.getElementById('rectangles');

        let image = null;
        let rectangles = [];
        let isDrawing = false;
        let startX, startY;
        let currentRect = null;

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        uploadArea.addEventListener('click', () => fileInput.click());

        // æ–‡ä»¶æ‹–æ‹½
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        });

        // åŠ è½½å›¾ç‰‡
        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                image = new Image();
                image.onload = () => {
                    canvas.width = image.width;
                    canvas.height = image.height;
                    rectangles = [];
                    redraw();
                    updateOutput();
                };
                image.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // é¼ æ ‡äº‹ä»¶
        canvas.addEventListener('mousedown', (e) => {
            if (!image) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            startX = (e.clientX - rect.left) * scaleX;
            startY = (e.clientY - rect.top) * scaleY;
            isDrawing = true;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const currentX = (e.clientX - rect.left) * scaleX;
            const currentY = (e.clientY - rect.top) * scaleY;

            currentRect = {
                x: Math.min(startX, currentX),
                y: Math.min(startY, currentY),
                w: Math.abs(currentX - startX),
                h: Math.abs(currentY - startY)
            };

            redraw();
        });

        canvas.addEventListener('mouseup', () => {
            if (isDrawing && currentRect && currentRect.w > 5 && currentRect.h > 5) {
                rectangles.push({
                    x: Math.round(currentRect.x),
                    y: Math.round(currentRect.y),
                    w: Math.round(currentRect.w),
                    h: Math.round(currentRect.h)
                });
                updateOutput();
            }
            isDrawing = false;
            currentRect = null;
            redraw();
        });

        // é‡ç»˜
        function redraw() {
            if (!image) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0);

            // ç»˜åˆ¶å·²ä¿å­˜çš„çŸ©å½¢
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            rectangles.forEach((r, i) => {
                ctx.strokeRect(r.x, r.y, r.w, r.h);
                ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                ctx.fillRect(r.x, r.y, r.w, r.h);

                // ç»˜åˆ¶ç¼–å·
                ctx.fillStyle = '#00ff00';
                ctx.font = 'bold 16px sans-serif';
                ctx.fillText(`#${i + 1}`, r.x + 5, r.y + 20);
            });

            // ç»˜åˆ¶å½“å‰æ­£åœ¨ç”»çš„çŸ©å½¢
            if (currentRect) {
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(currentRect.x, currentRect.y, currentRect.w, currentRect.h);
                ctx.setLineDash([]);
            }
        }

        // æ›´æ–°è¾“å‡º
        function updateOutput() {
            let text = '';
            rectanglesDiv.innerHTML = '';

            if (rectangles.length === 0) {
                output.textContent = 'è¿˜æ²¡æœ‰æ ‡æ³¨ä»»ä½•æ°´å°ä½ç½®';
                undoBtn.disabled = true;
                clearBtn.disabled = true;
                saveBtn.disabled = true;
                copyBtn.disabled = true;
                return;
            }

            text = `æ£€æµ‹åˆ° ${rectangles.length} ä¸ªæ°´å°ä½ç½®ï¼š\n\n`;
            rectangles.forEach((r, i) => {
                text += `${r.x},${r.y},${r.w},${r.h}\n`;

                // æ·»åŠ å¯è§†åŒ–åˆ—è¡¨
                const div = document.createElement('div');
                div.className = 'rect-info';
                div.innerHTML = `
                    <span>#${i + 1}: x=${r.x}, y=${r.y}, w=${r.w}, h=${r.h}</span>
                    <button onclick="deleteRect(${i})">åˆ é™¤</button>
                `;
                rectanglesDiv.appendChild(div);
            });

            output.textContent = text;
            undoBtn.disabled = false;
            clearBtn.disabled = false;
            saveBtn.disabled = false;
            copyBtn.disabled = false;
        }

        // åˆ é™¤æŒ‡å®šçŸ©å½¢
        window.deleteRect = function(index) {
            rectangles.splice(index, 1);
            redraw();
            updateOutput();
        };

        // æ’¤é”€
        undoBtn.addEventListener('click', () => {
            rectangles.pop();
            redraw();
            updateOutput();
        });

        // æ¸…ç©º
        clearBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ ‡æ³¨å—ï¼Ÿ')) {
                rectangles = [];
                redraw();
                updateOutput();
            }
        });

        // ä¿å­˜
        saveBtn.addEventListener('click', () => {
            const text = rectangles.map(r => `${r.x},${r.y},${r.w},${r.h}`).join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'watermark_positions.txt';
            a.click();
            URL.revokeObjectURL(url);
        });

        // å¤åˆ¶
        copyBtn.addEventListener('click', () => {
            const text = rectangles.map(r => `${r.x},${r.y},${r.w},${r.h}`).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nå¯ä»¥ç›´æ¥ç²˜è´´åˆ° template/watermark_positions.txt æ–‡ä»¶ä¸­ã€‚');
            });
        });
    </script>
</body>
</html>
